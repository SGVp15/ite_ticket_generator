import glob

import openpyxl


def combine_excel_files_no_pandas(output_filename="combined_data_openpyxl.xlsx"):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Ñ–∞–π–ª—ã .xlsx –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö
    –ª–∏—Å—Ç–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –æ–¥–∏–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª Excel —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º openpyxl.
    """

    # –®–∞–≥ 1: –ü–æ–∏—Å–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ Excel (–∏—Å–∫–ª—é—á–∞—è –±—É–¥—É—â–∏–π –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª)
    all_files = glob.glob("data/input/*.xlsx")
    excel_files = [f for f in all_files if f != output_filename]

    if not excel_files:
        print("‚ùå –§–∞–π–ª—ã Excel (.xlsx) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.")
        return

    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(excel_files)} —Ñ–∞–π–ª–æ–≤ Excel –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è: {excel_files}")

    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É (workbook) –∏ –ª–∏—Å—Ç –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    new_wb = openpyxl.Workbook()
    # –£–¥–∞–ª—è–µ–º –ª–∏—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    default_sheet = new_wb.active
    new_wb.remove(default_sheet)

    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    combined_ws = new_wb.create_sheet(title="Combined_Data")

    # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø–∏—Å–∏
    current_row = 1
    # –§–ª–∞–≥ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
    headers_written = False

    # –®–∞–≥ 2: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –∑–∞–ø–∏—Å—å –≤ –Ω–æ–≤—ã–π –ª–∏—Å—Ç
    for filename in excel_files:
        try:
            print(f"üìñ –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {filename}...")

            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É
            wb = openpyxl.load_workbook(filename, data_only=True)

            for sheet_name in wb.sheetnames:
                print(f"   -> –ß—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç–∞: {sheet_name}")
                ws = wb[sheet_name]

                # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º –Ω–∞ –ª–∏—Å—Ç–µ
                for row_index, row in enumerate(ws.iter_rows()):
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —è—á–µ–µ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                    row_data = [cell.value for cell in row]

                    # –°–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                    source_info = [filename, sheet_name]

                    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ª–∏—Å—Ç–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏)
                    if row_index == 0:
                        if not headers_written:
                            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ + –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                            combined_ws.append(row_data + ["Source_File", "Source_Sheet"])
                            current_row += 1
                            headers_written = True
                        else:
                            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã
                            continue

                            # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
                    elif row_index > 0:
                        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ
                        combined_ws.append(row_data + source_info)
                        current_row += 1


        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ {filename}: {e}")

    # –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if combined_ws.max_row == 1 and headers_written:
        print("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ, –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –Ω–µ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã.")
        # –ï—Å–ª–∏ –±—ã–ª–æ –∑–∞–ø–∏—Å–∞–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –Ω–æ –º—ã –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏–º
    elif not headers_written:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞. –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω.")
        return

    try:
        print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ {output_filename}...")
        new_wb.save(output_filename)
        print(f"üéâ –£—Å–ø–µ—à–Ω–æ! –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ '{output_filename}' –Ω–∞ –ª–∏—Å—Ç–µ 'Combined_Data'.")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")


if __name__ == "__main__":
    # –£–∫–∞–∂–∏ –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    combine_excel_files_no_pandas("Combined_Data_Result_NoPandas.xlsx")
